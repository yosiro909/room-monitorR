<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>å››å­£ã®ãƒ«ãƒ¼ãƒ ãƒ¢ãƒ‹ã‚¿ãƒ¼ v3.3.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --accent-blue: #00d2ff; --accent-red: #ff512f; --accent-green: #a8e6cf;
            --bg-glass: rgba(255, 255, 255, 0.12);
            --season-grad: linear-gradient(-45deg, #1e3c72, #2a5298, #000428, #004e92);
        }
        body { 
            font-family: 'Noto Sans JP', sans-serif; text-align: center; 
            background: var(--season-grad); background-size: 400% 400%; 
            animation: gradientBG 15s ease infinite; margin: 0; padding: 10px 15px 100px 15px; 
            color: #fff; min-height: 100vh; overflow-x: hidden;
        }
        #weather-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .snowflake { position: absolute; top: -20px; color: white; opacity: 0.7; animation: fall linear infinite, sideWays ease-in-out infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }
        @keyframes sideWays { 0%, 100% { margin-left: 0; } 50% { margin-left: 30px; } }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { max-width: 480px; margin: auto; position: relative; z-index: 2; }
        .content-page { display: none; opacity: 0; transform: translateY(10px); transition: 0.3s; }
        .content-page.active { display: block; opacity: 1; transform: translateY(0); }
        h1 { font-size: 24px; margin: 15px 0; border-bottom: 2px solid var(--accent-blue); display: inline-block; padding-bottom: 5px; }
        .card { background: var(--bg-glass); border-radius: 24px; padding: 20px; margin-bottom: 15px; text-align: left; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(5px); }
        .clock-card { text-align: center; }
        .date-display { font-size: 18px; font-family: 'Orbitron'; margin-bottom: 5px; }
        .time-display { font-size: 48px; font-weight: 700; font-family: 'Orbitron'; background: rgba(0,0,0,0.3); border-radius: 12px; display: block; padding: 8px 0; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .history-table th, .history-table td { padding: 8px 2px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .history-table th { color: var(--accent-blue); font-size: 10px; }
        .history-table td { font-family: 'Orbitron'; }
        .col-t { color: #ff8a75; } .col-h { color: #7de2ff; } .col-d { color: #a8e6cf; }
        .stats-title { font-size: 14px; text-align: left; margin: 20px 0 10px 10px; color: var(--accent-blue); font-weight: 900; border-left: 4px solid var(--accent-blue); padding-left: 10px;}
        .stats-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .stat-card { flex: 1; background: rgba(0,0,0,0.3); border-radius: 18px; padding: 12px 8px; border: 1px solid rgba(255,255,255,0.1); }
        .stat-label { font-size: 10px; opacity: 0.8; margin-bottom: 4px; }
        .stat-val { font-size: 16px; font-weight: 700; font-family: 'Orbitron'; }
        .m5-box { background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; margin-bottom: 15px; border-left: 8px solid #ccc; text-align: left; }
        .advice-card { background: rgba(255,255,255,0.08); border-radius: 15px; padding: 15px; margin-bottom: 12px; border-left: 4px solid var(--accent-blue); }
        .advice-header { font-size: 13px; font-weight: 900; margin-bottom: 5px; }
        .level-indicator { display: flex; gap: 5px; margin-bottom: 15px; height: 8px; }
        .level-step { flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; }
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(15px); display: flex; padding: 12px 0 25px 0; z-index: 100; }
        .tab-item { color: rgba(255,255,255,0.5); font-size: 12px; cursor: pointer; text-align: center; flex: 1; }
        .tab-item.active { color: #fff; text-shadow: 0 0 10px var(--accent-blue); }
        .tab-icon { font-size: 24px; display: block; }
        .label { font-size: 16px; margin-bottom: 5px; border-left: 4px solid var(--accent-blue); padding-left: 10px; font-weight: 700; }
        .value { font-size: 54px; font-weight: 700; font-family: 'Orbitron'; line-height: 1.1; }
        .unit { font-size: 20px; margin-left: 5px; }
        .chart-container { height: 160px; margin-bottom: 5px; }
        .chart-title { font-size: 12px; font-weight: bold; border-left: 3px solid #fff; padding-left: 8px; }
    </style>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwSrldtZzFPNiUz0tLuSnrVVMhwBDFYJztCp_t13VKVuqf697TWlljm9BU9ItWaAbcO/exec';
        let charts = { temp: null, humi: null, di: null };

        function startSnowEffect() {
            const layer = document.getElementById('weather-layer');
            layer.innerHTML = '';
            for(let i=0; i<40; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake'; s.innerHTML = 'â„';
                s.style.left = Math.random() * 100 + 'vw';
                s.style.animationDuration = (Math.random() * 3 + 4) + 's';
                s.style.fontSize = (Math.random() * 10 + 10) + 'px';
                layer.appendChild(s);
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.content-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('page_' + tabId).classList.add('active');
            document.getElementById('tab_' + tabId).classList.add('active');
        }

        function updateClock() {
            const now = new Date();
            const w = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][now.getDay()];
            document.getElementById('today_date').innerText = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} (${w})`;
            document.getElementById('current_time').innerText = now.toTimeString().split(' ')[0];
        }

        async function fetchLocation(ip) {
            const locEl = document.getElementById('dev_loc');
            if (!ip || ip === "----" || ip === "å–å¾—ä¸å¯") {
                locEl.innerText = "åˆ¤å®šä¸å¯";
                return;
            }
            if (ip.startsWith("192.168.") || ip.startsWith("10.") || ip.startsWith("172.")) {
                locEl.innerText = "ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯";
                return;
            }
            try {
                const res = await fetch(`https://ipapi.co/${ip}/json/`);
                if (!res.ok) throw new Error();
                const loc = await res.json();
                locEl.innerText = loc.city ? `${loc.region} ${loc.city}` : "åˆ¤å®šä¸å¯";
            } catch (e) {
                locEl.innerText = "å–å¾—åˆ¶é™ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼";
            }
        }

        async function updateData() {
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                const now = new Date();
                
                let isExpired = false;
                let lastFullTimeStr = "----/--/-- --:--:--";

                if (data.history && data.history.length > 0) {
                    const latest = data.history[0];
                    const cleanDate = latest.date.replace(/-/g, '/');
                    lastFullTimeStr = `${cleanDate} ${latest.time}`;
                    
                    let lastDataTime = new Date(lastFullTimeStr);
                    if (now.getTime() - lastDataTime.getTime() > 600000) isExpired = true;

                    const ip = data.ip || latest.ip || "å–å¾—ä¸å¯";
                    document.getElementById('dev_ip').innerText = ip;
                    fetchLocation(ip);
                }

                document.querySelectorAll('.val_t').forEach(el => el.innerText = isExpired ? "ãƒ¼" : Number(data.temp).toFixed(1));
                document.querySelectorAll('.val_h').forEach(el => el.innerText = isExpired ? "ãƒ¼" : Number(data.humi).toFixed(1));
                document.querySelectorAll('.val_d').forEach(el => el.innerText = isExpired ? "ãƒ¼" : Number(data.di).toFixed(1));
                document.getElementById('last_rx').innerText = lastFullTimeStr;

                if (data.history) {
                    let maxT = -99, minT = 99, maxH = -99, minH = 100;
                    let labels = [], tData = [], hData = [], dData = [];
                    let tableHtml = '';

                    data.history.forEach(row => {
                        const rt = Number(row.temp); const rh = Number(row.humi); const rd = Number(row.di);
                        if (rt > maxT) maxT = rt; if (rt < minT) minT = rt;
                        if (rh > maxH) maxH = rh; if (rh < minH) minH = rh;
                        
                        labels.unshift(row.time); 
                        tData.unshift(rt); hData.unshift(rh); dData.unshift(rd);

                        const shortDate = row.date.split('-').slice(1).join('/'); 
                        tableHtml += `<tr>
                            <td style="color:var(--accent-blue); font-size:10px;">${shortDate}</td>
                            <td>${row.time}</td>
                            <td class="col-t">${rt.toFixed(1)}</td>
                            <td class="col-h">${rh.toFixed(0)}</td>
                            <td class="col-d">${rd.toFixed(0)}</td>
                        </tr>`;
                    });

                    document.getElementById('history_body').innerHTML = tableHtml;
                    document.getElementById('max_t').innerText = maxT.toFixed(1);
                    document.getElementById('min_t').innerText = minT.toFixed(1);
                    document.getElementById('max_h').innerText = maxH.toFixed(1);
                    document.getElementById('min_h').innerText = minH.toFixed(1);
                    
                    updateCharts(labels, tData, hData, dData);
                    updateAdviceUI(isExpired, Number(data.temp), Number(data.humi), Number(data.di));
                }
            } catch (e) { console.error("Update Error:", e); }
        }

        function updateAdviceUI(isExpired, t, h, di) {
            const msgBox = document.getElementById('m5_box');
            const msgStatus = document.getElementById('m5_status');
            const msgText = document.getElementById('m5_msg');
            const steps = [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3'), document.getElementById('s4')];

            if (isExpired) {
                msgStatus.innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³"; 
                msgText.innerText = "ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ä¿¡å·ãŒé€”çµ¶ãˆã¦ã„ã¾ã™ã€‚";
                msgBox.style.borderLeftColor = "#ccc";
                steps.forEach(s => s.style.background = "rgba(255,255,255,0.1)");
            } else {
                steps.forEach(s => s.style.background = "rgba(255,255,255,0.1)");
                if (di >= 80) {
                    msgStatus.innerText = "ğŸš¨ è­¦æˆ’ãƒ¬ãƒ™ãƒ«"; 
                    msgText.innerText = "ä¸å¿«æŒ‡æ•°ãŒéå¸¸ã«é«˜ã„ã§ã™ã€‚å†·æˆ¿ã‚„æ›æ°—ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚";
                    msgBox.style.borderLeftColor = "#ff512f";
                    steps.forEach(s => s.style.background = "#ff512f");
                } else if (di >= 75) {
                    msgStatus.innerText = "âš ï¸ æ³¨æ„ãƒ¬ãƒ™ãƒ«"; 
                    msgText.innerText = "ã‚„ã‚„è’¸ã—æš‘ã•ã‚’æ„Ÿã˜ã¾ã™ã€‚é©åˆ‡ãªæ¸©åº¦èª¿ç¯€ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚";
                    msgBox.style.borderLeftColor = "#ffcc00";
                    [steps[0], steps[1], steps[2]].forEach(s => s.style.background = "#ffcc00");
                } else {
                    msgStatus.innerText = "âœ¨ å¿«é©ç’°å¢ƒ"; 
                    msgText.innerText = "ç¾åœ¨ã€ãŠéƒ¨å±‹ã¯éå¸¸ã«éã”ã—ã‚„ã™ã„ç’°å¢ƒã«ä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚";
                    msgBox.style.borderLeftColor = "#00d2ff";
                    steps[0].style.background = "#00d2ff";
                }
                document.getElementById('temp_advice_text').innerText = t >= 28 ? "å†·æˆ¿ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚" : (t <= 18 ? "æš–æˆ¿ç­‰ã§ä¿æ¸©ã—ã¦ãã ã•ã„ã€‚" : "é©åˆ‡ãªæ¸©åº¦ã§ã™ã€‚");
                document.getElementById('humi_advice_text').innerText = h <= 40 ? "ä¹¾ç‡¥ã«æ³¨æ„ã€‚åŠ æ¹¿ã‚’æ¨å¥¨ã€‚" : (h >= 70 ? "æ¹¿æ°—ãŒå¤šã„ã§ã™ã€‚æ›æ°—ã‚’ã€‚" : "ç†æƒ³çš„ãªæ¹¿åº¦ã§ã™ã€‚");
            }
        }

        function updateCharts(labels, tData, hData, dData) {
            const cfg = (label, data, color) => ({
                type: 'line',
                data: { labels, datasets: [{ label, data, borderColor: color, borderWidth: 2, pointRadius: 2, pointHoverRadius: 6, fill: false, tension: 0.3 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)', titleFont: { size: 10 }, bodyFont: { size: 12, family: 'Orbitron' }, displayColors: false } 
                    }, 
                    scales: { 
                        x: { ticks: { color: '#fff', font: { size: 8 } }, grid: { display: false } }, 
                        y: { ticks: { color: '#fff', font: { size: 8 } }, grid: { color: 'rgba(255,255,255,0.1)' } } 
                    } 
                }
            });
            if (!charts.temp) {
                charts.temp = new Chart(document.getElementById('tempChart'), cfg('æ¸©åº¦', tData, '#ff512f'));
                charts.humi = new Chart(document.getElementById('humiChart'), cfg('æ¹¿åº¦', hData, '#00d2ff'));
                charts.di = new Chart(document.getElementById('diChart'), cfg('æŒ‡æ•°', dData, '#a8e6cf'));
            } else {
                charts.temp.data.labels = labels; charts.temp.data.datasets[0].data = tData; charts.temp.update('none');
                charts.humi.data.labels = labels; charts.humi.data.datasets[0].data = hData; charts.humi.update('none');
                charts.di.data.labels = labels; charts.di.data.datasets[0].data = dData; charts.di.update('none');
            }
        }

        window.onload = () => { startSnowEffect(); showTab('home'); updateClock(); updateData(); setInterval(updateData, 30000); setInterval(updateClock, 1000); };
    </script>
</head>
<body>
    <div id="weather-layer"></div>
    <div class="container">
        <div id="page_home" class="content-page active">
            <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div class="card clock-card">
                <div id="today_date" class="date-display">----/--/-- (-)</div>
                <div id="current_time" class="time-display">00:00:00</div>
            </div>
            <div class="card"><div class="label">ç¾åœ¨ã®æ¸©åº¦</div><div class="value"><span class="val_t">--.-</span><span class="unit">â„ƒ</span></div></div>
            <div class="card"><div class="label">ç¾åœ¨ã®æ¹¿åº¦</div><div class="value"><span class="val_h">--.-</span><span class="unit">%</span></div></div>
            <div class="card"><div class="label">ä¸å¿«æŒ‡æ•°</div><div class="value"><span class="val_d">--.-</span><span class="unit">pt</span></div></div>
            <div class="stats-title">æœ¬æ—¥ã®çµ±è¨ˆ (ç›´è¿‘20ä»¶)</div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">æœ€é«˜/æœ€ä½æ°—æ¸©</div><div class="stat-val"><span id="max_t">--.-</span> / <span id="min_t">--.-</span> â„ƒ</div></div>
                <div class="stat-card"><div class="stat-label">æœ€é«˜/æœ€ä½æ¹¿åº¦</div><div class="stat-val"><span id="max_h">--.-</span> / <span id="min_h">--.-</span> %</div></div>
            </div>
        </div>
        
        <div id="page_history" class="content-page">
            <h1>ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</h1>
            <div class="card">
                <div class="chart-title" style="color:#ff512f;">æ¸©åº¦æ¨ç§»</div>
                <div class="chart-container"><canvas id="tempChart"></canvas></div>
                <div class="chart-title" style="color:#00d2ff; margin-top:10px;">æ¹¿åº¦æ¨ç§»</div>
                <div class="chart-container"><canvas id="humiChart"></canvas></div>
                <div class="chart-title" style="color:#a8e6cf; margin-top:10px;">ä¸å¿«æŒ‡æ•°æ¨ç§»</div>
                <div class="chart-container"><canvas id="diChart"></canvas></div>
            </div>
            <div class="card">
                <div class="chart-title">å±¥æ­´ãƒ­ã‚°</div>
                <table class="history-table">
                    <thead><tr><th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>æ¸©åº¦</th><th>æ¹¿åº¦</th><th>æŒ‡æ•°</th></tr></thead>
                    <tbody id="history_body"></tbody>
                </table>
            </div>
        </div>

        <div id="page_advice" class="content-page">
            <h1>ç’°å¢ƒã‚¢ãƒ‰ãƒã‚¤ã‚¹</h1>
            <div class="m5-box" id="m5_box">
                <span id="m5_status" style="font-weight:900;">è§£æä¸­...</span>
                <div class="level-indicator">
                    <div class="level-step" id="s1"></div><div class="level-step" id="s2"></div><div class="level-step" id="s3"></div><div class="level-step" id="s4"></div>
                </div>
                <span id="m5_msg">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>
            </div>
            <div class="advice-card"><div class="advice-header">ğŸŒ¡ æ¸©åº¦</div><div id="temp_advice_text">åˆ†æä¸­...</div></div>
            <div class="advice-card"><div class="advice-header">ğŸ’§ æ¹¿åº¦</div><div id="humi_advice_text">åˆ†æä¸­...</div></div>
        </div>

        <div id="page_device" class="content-page">
            <h1>ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±</h1>
            <div class="card">
                <p style="line-height: 2.2;">
                    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span style="color:#00ff00;">â— ONLINE</span><br>
                    æœ€çµ‚å—ä¿¡: <span id="last_rx" style="color:var(--accent-blue);">----/--/-- --:--:--</span><br>
                    IPã‚¢ãƒ‰ãƒ¬ã‚¹: <span id="dev_ip" style="color:var(--accent-blue); font-family:'Orbitron';">----</span><br>
                    æ¨å®šç¾åœ¨åœ°: <span id="dev_loc" style="color:var(--accent-green);">å–å¾—ä¸­...</span>
                </p>
                <p style="font-size:10px; opacity:0.6; margin-top:15px;">â€»IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯M5Stackã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸãƒ­ã‚°ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚ç¾åœ¨åœ°ã¯IPã«åŸºã¥ãæ¨æ¸¬ã§ã‚ã‚Šèª¤å·®ãŒã‚ã‚Šã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="tab_home" onclick="showTab('home')"><span class="tab-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </div>
        <div class="tab-item" id="tab_history" onclick="showTab('history')"><span class="tab-icon">ğŸ“œ</span>å±¥æ­´</div>
        <div class="tab-item" id="tab_advice" onclick="showTab('advice')"><span class="tab-icon">ğŸ’¡</span>ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
        <div class="tab-item" id="tab_device" onclick="showTab('device')"><span class="tab-icon">ğŸ“¡</span>æƒ…å ±</div>
    </div>
</body>
</html>
